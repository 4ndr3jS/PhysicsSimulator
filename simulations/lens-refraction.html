<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lens Refraction - Physics Simulator</title>
    <link rel="stylesheet" href="simulations.css">
</head>
<body>
    <nav>
        <a href="index.html">Physics Simulator</a>
        <ul>
            <a href="index.html">Home</a>
            <a href="simulations.html">Simulations</a>
            <a href="guide.html">Guide</a>
            <a href="theory.html">Theory</a>
        </ul>
    </nav>

    <div class="sim-container">
        <div class="sim-header">
            <h1>üî¶ Lens Refraction & Ray Tracing</h1>
            <p>Watch light rays refract through a curved lens surface</p>
            <p class="sim-subtitle">Difficulty: <span class="sim-badge sim-badge-medium">‚óè Medium</span></p>
        </div>

        <div class="sim-layout">
            <div class="sim-canvas-section">
                <div class="sim-canvas-wrapper">
                    <canvas id="simCanvas" class="sim-canvas" width="800" height="500"></canvas>
                    
                    <div class="sim-controls">
                        <button class="sim-btn sim-btn-primary" onclick="startSimulation()">‚ñ∂Ô∏è Start Rays</button>
                        <button class="sim-btn sim-btn-secondary" onclick="pauseSimulation()" id="pauseBtn">‚è∏Ô∏è Pause</button>
                        <button class="sim-btn sim-btn-secondary" onclick="resetSimulation()">üîÑ Reset</button>
                    </div>
                </div>

                <div class="sim-panel">
                    <div class="sim-panel-header">
                        <span class="sim-panel-icon">üìê</span>
                        <span>Physics Formulas</span>
                    </div>
                    <div class="sim-formula">
                        <div class="sim-formula-equation">n‚ÇÅ sin(Œ∏‚ÇÅ) = n‚ÇÇ sin(Œ∏‚ÇÇ)</div>
                        <div class="sim-formula-description">Snell's Law</div>
                    </div>
                    <div class="sim-formula">
                        <div class="sim-formula-equation">n = c / v</div>
                        <div class="sim-formula-description">Refractive index</div>
                    </div>
                    <div class="sim-formula">
                        <div class="sim-formula-equation">Œ∏c = arcsin(n‚ÇÇ/n‚ÇÅ)</div>
                        <div class="sim-formula-description">Critical angle</div>
                    </div>
                    <div class="sim-formula">
                        <div class="sim-formula-equation">v‚ÇÇ = v‚ÇÅ(n‚ÇÅ/n‚ÇÇ)</div>
                        <div class="sim-formula-description">Speed in medium</div>
                    </div>
                </div>

                <div class="sim-panel">
                    <div class="sim-panel-header">
                        <span class="sim-panel-icon">üìö</span>
                        <span>Key Concepts</span>
                    </div>
                    <ul class="sim-info-list">
                        <li>Light bends when entering different medium</li>
                        <li>Curved surface causes rays to converge or diverge</li>
                        <li>Light slows down in denser medium</li>
                        <li>Angle of refraction depends on refractive indices</li>
                        <li>Each ray bends individually based on its angle</li>
                    </ul>
                </div>

                <div class="sim-panel">
                    <div class="sim-panel-header">
                        <span class="sim-panel-icon">üî¨</span>
                        <span>Try This</span>
                    </div>
                    <ul class="sim-info-list">
                        <li>Watch parallel rays converge as they enter the lens</li>
                        <li>Adjust refractive index to change bending amount</li>
                        <li>Change curvature to see different focal points</li>
                        <li>Increase ray count for denser light beam</li>
                        <li>Observe how rays slow down inside the medium</li>
                    </ul>
                </div>
            </div>

            <div class="sim-sidebar">
                <div class="sim-panel">
                    <div class="sim-panel-header">
                        <span class="sim-panel-icon">‚öôÔ∏è</span>
                        <span>Lens Properties</span>
                    </div>

                    <div class="sim-control-group">
                        <div class="sim-control-label">
                            <span>Refractive Index (n)</span>
                            <span class="sim-control-value"><span id="val-n">1.5</span></span>
                        </div>
                        <input type="range" id="slider-n" min="1.3" max="2.0" step="0.05" value="1.5" oninput="updateParameter('n', this.value)">
                        <div style="font-size: 0.85rem; color: #888; margin-top: 0.25rem;">Glass (1.5), Water (1.33), Diamond (2.42)</div>
                    </div>

                    <div class="sim-control-group">
                        <div class="sim-control-label">
                            <span>Surface Curvature</span>
                            <span class="sim-control-value"><span id="val-curvature">150</span> px</span>
                        </div>
                        <input type="range" id="slider-curvature" min="100" max="300" step="10" value="150" oninput="updateParameter('curvature', this.value)">
                    </div>

                    <div class="sim-control-group">
                        <div class="sim-control-label">
                            <span>Lens Thickness</span>
                            <span class="sim-control-value"><span id="val-thickness">150</span> px</span>
                        </div>
                        <input type="range" id="slider-thickness" min="100" max="250" step="10" value="150" oninput="updateParameter('thickness', this.value)">
                    </div>

                    <div class="sim-control-group">
                        <div class="sim-control-label">
                            <span>Number of Rays</span>
                            <span class="sim-control-value"><span id="val-rays">9</span></span>
                        </div>
                        <input type="range" id="slider-rays" min="5" max="15" step="2" value="9" oninput="updateParameter('rays', this.value)">
                    </div>

                    <div class="sim-control-group">
                        <div class="sim-control-label">
                            <span>Ray Speed</span>
                            <span class="sim-control-value"><span id="val-speed">1.5</span></span>
                        </div>
                        <input type="range" id="slider-speed" min="0.5" max="3.0" step="0.5" value="1.5" oninput="updateParameter('speed', this.value)">
                    </div>

                    <div class="sim-divider"></div>

                    <div class="sim-toggle">
                        <span>Show Focal Point</span>
                        <div class="sim-toggle-switch active" id="toggle-focal" onclick="toggleFocal()"></div>
                    </div>

                    <div class="sim-toggle">
                        <span>Show Normals</span>
                        <div class="sim-toggle-switch" id="toggle-normals" onclick="toggleNormals()"></div>
                    </div>

                    <div class="sim-toggle">
                        <span>Show Ray Trails</span>
                        <div class="sim-toggle-switch active" id="toggle-trails" onclick="toggleTrails()"></div>
                    </div>
                </div>

                <div class="sim-stats">
                    <div class="sim-stat-card">
                        <div class="sim-stat-value blue" id="stat-focal">0</div>
                        <div class="sim-stat-label">Approx Focal Length (px)</div>
                    </div>
                    <div class="sim-stat-card">
                        <div class="sim-stat-value green" id="stat-active">0</div>
                        <div class="sim-stat-label">Active Rays</div>
                    </div>
                    <div class="sim-stat-card">
                        <div class="sim-stat-value purple" id="stat-speed">0</div>
                        <div class="sim-stat-label">Speed in Medium (c/n)</div>
                    </div>
                    <div class="sim-stat-card">
                        <div class="sim-stat-value orange" id="stat-angle">0</div>
                        <div class="sim-stat-label">Max Refraction Angle</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        const W = 800, H = 500;
        const CY = H / 2;
        
        let running = false, aid = null;
        let showFocal = true, showNormals = false, showTrails = true;
        
        let params = {
            n: 1.5,
            curvature: 150,
            thickness: 150,
            rays: 9,
            speed: 1.5
        };

        let rays = [];
        let raySpawnTimer = 0;
        let lensX = 500;

        class Ray {
            constructor(y) {
                this.segments = [];
                this.currentSegment = 0;
                this.progress = 0;
                this.startY = y;
                this.color = '#ffeb6b';
                this.active = true;
                this.normal = null;
                
                this.calculatePath();
            }

            calculatePath() {
                const intersectionPoint = this.findIntersection(this.startY);
                
                if (!intersectionPoint) {
                    this.segments.push({
                        x1: 0,
                        y1: this.startY,
                        x2: W,
                        y2: this.startY,
                        type: 'miss'
                    });
                    return;
                }

                this.segments.push({
                    x1: 0,
                    y1: this.startY,
                    x2: intersectionPoint.x,
                    y2: intersectionPoint.y,
                    type: 'incident'
                });

                const dx = intersectionPoint.x - (lensX - params.curvature);
                const dy = intersectionPoint.y - CY;
                const normalAngle = Math.atan2(dy, dx);
                this.normal = { x: intersectionPoint.x, y: intersectionPoint.y, angle: normalAngle };

                const incidentAngle = 0;
                const theta1 = normalAngle - incidentAngle;
                const sinTheta2 = (1.0 / params.n) * Math.sin(theta1);
                
                if (Math.abs(sinTheta2) > 1) {
                    this.active = false;
                    return;
                }
                
                const theta2 = Math.asin(sinTheta2);
                const refractedAngle = normalAngle - theta2;

                const travelDist = params.thickness;
                const endX = intersectionPoint.x + travelDist * Math.cos(refractedAngle);
                const endY = intersectionPoint.y + travelDist * Math.sin(refractedAngle);

                this.segments.push({
                    x1: intersectionPoint.x,
                    y1: intersectionPoint.y,
                    x2: endX,
                    y2: endY,
                    type: 'inside'
                });

                this.segments.push({
                    x1: endX,
                    y1: endY,
                    x2: W,
                    y2: endY + (W - endX) * Math.tan(refractedAngle),
                    type: 'exit'
                });
            }

            findIntersection(y) {
                const centerX = lensX - params.curvature;
                const centerY = CY;
                const radius = params.curvature;

                const dy = y - centerY;
                if (Math.abs(dy) > radius) {
                    return null;
                }

                const dx = Math.sqrt(radius * radius - dy * dy);
                const intersectX = centerX + dx;

                return { x: intersectX, y: y };
            }

            update(dt) {
                if (!this.active || this.currentSegment >= this.segments.length) {
                    this.active = false;
                    return;
                }

                const segment = this.segments[this.currentSegment];
                const length = Math.sqrt((segment.x2 - segment.x1) ** 2 + (segment.y2 - segment.y1) ** 2);
                const speed = params.speed * (segment.type === 'inside' ? (1 / params.n) : 1);
                
                this.progress += (speed / length) * dt * 60;

                if (this.progress >= 1) {
                    this.progress = 0;
                    this.currentSegment++;
                }
            }

            draw() {
                for (let i = 0; i < this.currentSegment; i++) {
                    const seg = this.segments[i];
                    ctx.strokeStyle = this.color;
                    ctx.lineWidth = 2;
                    ctx.globalAlpha = showTrails ? 0.6 : 0.3;
                    ctx.beginPath();
                    ctx.moveTo(seg.x1, seg.y1);
                    ctx.lineTo(seg.x2, seg.y2);
                    ctx.stroke();
                }
                if (this.currentSegment < this.segments.length) {
                    const seg = this.segments[this.currentSegment];
                    const currentX = seg.x1 + (seg.x2 - seg.x1) * this.progress;
                    const currentY = seg.y1 + (seg.y2 - seg.y1) * this.progress;

                    ctx.strokeStyle = this.color;
                    ctx.lineWidth = 2;
                    ctx.globalAlpha = 1;
                    ctx.beginPath();
                    ctx.moveTo(seg.x1, seg.y1);
                    ctx.lineTo(currentX, currentY);
                    ctx.stroke();

                    ctx.fillStyle = this.color;
                    ctx.globalAlpha = 1;
                    ctx.beginPath();
                    ctx.arc(currentX, currentY, 3, 0, Math.PI * 2);
                    ctx.fill();

                    const gradient = ctx.createRadialGradient(currentX, currentY, 0, currentX, currentY, 8);
                    gradient.addColorStop(0, 'rgba(255, 235, 107, 0.8)');
                    gradient.addColorStop(1, 'rgba(255, 235, 107, 0)');
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(currentX, currentY, 8, 0, Math.PI * 2);
                    ctx.fill();
                }

                if (showNormals && this.normal && this.currentSegment >= 1) {
                    ctx.strokeStyle = '#ff6b6b';
                    ctx.lineWidth = 1;
                    ctx.setLineDash([3, 3]);
                    ctx.beginPath();
                    const len = 30;
                    ctx.moveTo(this.normal.x - len * Math.cos(this.normal.angle), 
                              this.normal.y - len * Math.sin(this.normal.angle));
                    ctx.lineTo(this.normal.x + len * Math.cos(this.normal.angle), 
                              this.normal.y + len * Math.sin(this.normal.angle));
                    ctx.stroke();
                    ctx.setLineDash([]);
                }

                ctx.globalAlpha = 1;
            }
        }

        function draw() {
            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(0, 0, W, H);


            const centerX = lensX - params.curvature;
            const centerY = CY;
            const radius = params.curvature;

            const angleSpan = Math.asin(Math.min(1, 250 / radius));

            ctx.fillStyle = 'rgba(100, 150, 255, 0.2)';
            ctx.beginPath();
            
            ctx.arc(centerX, centerY, radius, -angleSpan, angleSpan);

            const topY = centerY - radius * Math.sin(angleSpan);
            const bottomY = centerY + radius * Math.sin(angleSpan);
            ctx.lineTo(lensX + params.thickness, bottomY);
            ctx.lineTo(lensX + params.thickness, topY);
            ctx.closePath();
            ctx.fill();

            ctx.strokeStyle = '#6b9eff';
            ctx.lineWidth = 3;
            ctx.stroke();

            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(0, CY);
            ctx.lineTo(W, CY);
            ctx.stroke();
            ctx.setLineDash([]);
            if (showFocal) {
                const f = params.curvature * params.n / (params.n - 1);
                const focalX = lensX + f;

                if (focalX < W && focalX > lensX) {
                    ctx.strokeStyle = '#ff6b6b';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.moveTo(focalX, CY - 30);
                    ctx.lineTo(focalX, CY + 30);
                    ctx.stroke();
                    ctx.setLineDash([]);

                    ctx.fillStyle = '#ff6b6b';
                    ctx.font = '14px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('F', focalX, CY + 50);
                }
            }

            rays.forEach(ray => ray.draw());

            const activeRays = rays.filter(r => r.active).length;
            const f = params.curvature * params.n / (params.n - 1);
            const speedRatio = (1 / params.n).toFixed(3);
            
            let maxAngle = 0;
            rays.forEach(ray => {
                if (ray.normal) {
                    const angle = Math.abs(ray.normal.angle * 180 / Math.PI);
                    maxAngle = Math.max(maxAngle, angle);
                }
            });
            
            document.getElementById('stat-focal').textContent = f.toFixed(1);
            document.getElementById('stat-active').textContent = activeRays;
            document.getElementById('stat-speed').textContent = speedRatio;
            document.getElementById('stat-angle').textContent = maxAngle.toFixed(1) + '¬∞';
        }

        function update(dt) {
            rays.forEach(ray => ray.update(dt));

            rays = rays.filter(r => r.active);

            if (running) {
                raySpawnTimer += dt;
                if (raySpawnTimer > 0.4) {
                    raySpawnTimer = 0;
                    const spacing = 400 / (params.rays - 1);
                    const startY = CY - 200;
                    
                    for (let i = 0; i < params.rays; i++) {
                        const y = startY + i * spacing;
                        rays.push(new Ray(y));
                    }
                }
            }
        }

        function anim() {
            if (!running) return;
            update(0.016);
            draw();
            aid = requestAnimationFrame(anim);
        }

        function startSimulation() {
            if (!running) {
                running = true;
                rays = [];
                raySpawnTimer = 0;
                anim();
            }
        }

        function pauseSimulation() {
            if (running) {
                running = false;
                cancelAnimationFrame(aid);
                document.getElementById('pauseBtn').textContent = '‚ñ∂Ô∏è Play';
            } else {
                running = true;
                document.getElementById('pauseBtn').textContent = '‚è∏Ô∏è Pause';
                anim();
            }
        }

        function resetSimulation() {
            running = false;
            cancelAnimationFrame(aid);
            rays = [];
            raySpawnTimer = 0;
            document.getElementById('pauseBtn').textContent = '‚è∏Ô∏è Pause';
            draw();
        }

        function updateParameter(p, v) {
            document.getElementById(`val-${p}`).textContent = v;
            params[p] = parseFloat(v);
            
            rays = [];
            raySpawnTimer = 0;
            
            draw();
        }

        function toggleFocal() {
            showFocal = !showFocal;
            document.getElementById('toggle-focal').classList.toggle('active');
            draw();
        }

        function toggleNormals() {
            showNormals = !showNormals;
            document.getElementById('toggle-normals').classList.toggle('active');
            draw();
        }

        function toggleTrails() {
            showTrails = !showTrails;
            document.getElementById('toggle-trails').classList.toggle('active');
            draw();
        }

        draw();
    </script>
</body>
</html>